import json
import kfp.dsl as kfp_dsl
from kfp.dsl import Input, Output, Dataset, HTML, Metrics, ClassificationMetrics, Artifact, Model

{{ lightweight_components | join('\n\n') }}

@kfp_dsl.pipeline(
    name='{{ pipeline_name }}',
    description='{{ pipeline_description }}'
)
def auto_generated_pipeline(
{%- for param_name, param_info in pipeline_param_info.items() %}
    {{ param_name.lower() }}: {{ param_info.type }} = {% if param_info.type == 'bool' %}{{ param_info.default }}{% else %}{{ param_info.default | tojson }}{% endif %}{% if not loop.last %},{% endif %}
{%- endfor %}
):
    """Auto-generated pipeline function."""

{% set steps_list = pipeline.steps | list %}
{% for step in steps_list %}
    {{ step.name }}_task = {{ step.name }}_step(
    {%- if step_inputs.get(step.name) %}
        {%- for input_var in step_inputs[step.name] %}
        {{ input_var }}_input_artifact={{ step_inputs_sources[step.name][input_var] }}_task.outputs["{{ input_var }}_output_artifact"]{% if not loop.last or pipeline_param_info %},{% endif %}
        {%- endfor %}
    {%- endif %}
    {%- if pipeline_param_info %}
        {%- for param_name, param_info in pipeline_param_info.items() %}
        {{ param_info.clean_name }}={{ param_name.lower() }}{% if not loop.last %},{% endif %}
        {%- endfor %}
    {%- endif %}
    )

    {% if loop.index0 > 0 %}
    {%- if step_inputs.get(step.name) %}
    {%- for input_var in step_inputs[step.name] %}
    {{ step.name }}_task.after({{ step_inputs_sources[step.name][input_var] }}_task)
    {%- endfor %}
    {%- else %}
    {{ step.name }}_task.after({{ steps_list[loop.index0 - 1].name }}_task)
    {%- endif %}
    {% endif %}

    {{ step.name }}_task.set_display_name("{{ component_names[step.name] }}-step")

    {%- if step.config.limits %}
    {%- for limit_key, limit_value in step.config.limits.items() %}
    {%- if limit_key in ['nvidia.com/gpu', 'amd.com/gpu'] %}
    {{ step.name }}_task.set_accelerator_type("{{ limit_key }}").set_accelerator_limit({{ limit_value }})
    {%- endif %}
    {%- endfor %}
    {%- endif %}

{% endfor %}

if __name__ == "__main__":
    from kfp import compiler

    pipeline_filename = auto_generated_pipeline.__name__ + '.yaml'
    compiler.Compiler().compile(auto_generated_pipeline, pipeline_filename)

    print(f"Pipeline compiled to {pipeline_filename}")
    print("To run, upload this YAML to your KFP v2 instance or use kfp.Client().create_run_from_pipeline_func.")
